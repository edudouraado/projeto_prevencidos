<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SBFarma | Controle de Estoque</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #003366; /* Azul Institucional */
            --primary-hover: #002244;
            --surface: #ffffff;
            --background: #f3f4f6;
            --text-main: #111827;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --success: #10b981;
            --danger: #ef4444;
            --radius: 8px;
            --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-main);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* HEADER */
        header {
            background-color: var(--primary);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .header-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .brand img { height: 40px; width: auto; }
        
        .brand-text h1 { font-size: 1.125rem; font-weight: 600; margin: 0; }
        .brand-text p { font-size: 0.8rem; margin: 0; opacity: 0.8; }

        /* MAIN CONTENT */
        main {
            flex: 1;
            width: 100%;
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1.5rem;
            display: grid;
            gap: 2rem;
        }

        @media (min-width: 768px) {
            main { grid-template-columns: 400px 1fr; align-items: start; }
        }

        /* CARDS */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .card-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border);
            background-color: #f9fafb;
        }

        .card-header h2 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-body { padding: 1.5rem; }

        /* FORMS */
        .form-group { margin-bottom: 1.25rem; }
        
        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-main);
            margin-bottom: 0.5rem;
        }

        input, select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #fff;
        }

        input:focus, select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1);
        }

        /* Readonly Field */
        input[readonly] {
            background-color: #f3f4f6;
            color: var(--text-secondary);
            cursor: not-allowed;
            border-color: #e5e7eb;
        }

        /* Grid for Inputs */
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

        /* Barcode Input Highlight */
        #barcode {
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: 1px;
            text-align: center;
            border-color: #93c5fd;
            background-color: #eff6ff;
        }
        #barcode:focus { border-color: var(--primary); background-color: #fff; }

        /* BUTTONS */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 0.875rem;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: background 0.2s;
            gap: 0.5rem;
        }

        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-primary:disabled { background-color: #9ca3af; cursor: not-allowed; }

        .btn-outline-danger {
            background-color: transparent;
            color: var(--danger);
            border: 1px solid var(--danger);
            margin-top: 1rem;
            font-size: 0.875rem;
        }
        .btn-outline-danger:hover { background-color: #fef2f2; }

        /* LIST & SEARCH */
        .search-box {
            position: relative;
            margin-bottom: 0;
            border-bottom: 1px solid var(--border);
        }
        .search-box input {
            border: none;
            border-radius: 0;
            padding: 1rem 1.25rem 1rem 2.5rem;
            background: transparent;
        }
        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
        }

        .item-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 500px;
            overflow-y: auto;
        }

        .list-item {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.1s;
        }
        .list-item:hover { background-color: #f9fafb; }
        .list-item:last-child { border-bottom: none; }

        .item-content h4 {
            margin: 0 0 0.25rem 0;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .meta-info {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .meta-tag {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* ACTIONS */
        .actions { display: flex; gap: 0.5rem; }
        
        .icon-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        .icon-btn:hover { background-color: #e5e7eb; color: var(--text-main); }
        .icon-btn.delete:hover { background-color: #fee2e2; color: var(--danger); }

        /* SVG ICONS */
        .icon { width: 18px; height: 18px; stroke-width: 2; stroke: currentColor; fill: none; stroke-linecap: round; stroke-linejoin: round; }

        /* FOOTER DISCRETO */
        footer {
            text-align: center;
            padding: 2rem 0;
            margin-top: auto;
            border-top: 1px solid #e5e7eb;
            color: var(--text-secondary);
            font-size: 0.75rem;
            background-color: #f9fafb;
        }
        footer p { margin: 0.25rem 0; }
        footer strong { color: inherit; font-weight: 600; }

        /* TOAST */
        #toast-container {
            position: fixed; top: 1rem; right: 1rem; z-index: 50;
            display: flex; flex-direction: column; gap: 0.5rem;
        }
        .toast {
            background: white;
            padding: 1rem;
            border-radius: var(--radius);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary);
            font-size: 0.875rem;
            font-weight: 500;
            animation: slideIn 0.3s ease;
        }
        .toast.error { border-left-color: var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    </style>
</head>
<body>

<div id="toast-container"></div>

<header>
    <div class="header-container">
        <div class="brand">
            <img src="SB_farma_oficial_branco-01.png" alt="SB Farma">
            <div class="brand-text">
                <h1>SBFarma</h1>
                <p>Controle de Validade</p>
            </div>
        </div>
    </div>
</header>

<main>
    <div class="card">
        <div class="card-header">
            <h2>
                <svg class="icon" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                Registro de Item
            </h2>
        </div>
        <div class="card-body">
            <form id="inventory-form">
                
                <div class="form-group">
                    <label>Loja / Filial</label>
                    <select id="store" required>
                        <option value="" disabled selected>Selecione a unidade...</option>
                        <option value="LOJA 01 - POUPE FARMA APUAIRES">LOJA 01 - POUPE FARMA APUAIRES</option>
                        <option value="LOJA 02 - ULTRA POPULAR TRAIRI">LOJA 02 - ULTRA POPULAR TRAIRI</option>
                        <option value="LOJA 03 - GOTA MAIS MARACANAU">LOJA 03 - GOTA MAIS MARACANAU</option>
                        <option value="LOJA 04 - ULTRA POPULAR MARANGUAPE">LOJA 04 - ULTRA POPULAR MARANGUAPE</option>
                        <option value="LOJA 05 - ULTRA POPULAR M. LUCENA">LOJA 05 - ULTRA POPULAR M. LUCENA</option>
                        <option value="LOJA 06 - POUPE FARMA PENTECOSTE">LOJA 06 - POUPE FARMA PENTECOSTE</option>
                        <option value="LOJA 07 - ULTRA POPULAR ITAPIPOCA">LOJA 07 - ULTRA POPULAR ITAPIPOCA</option>
                        <option value="LOJA 08 - ULTRA POPULAR PARAIPABA">LOJA 08 - ULTRA POPULAR PARAIPABA</option>
                        <option value="LOJA 09 - ULTRA POPULAR PARACURU">LOJA 09 - ULTRA POPULAR PARACURU</option>
                        <option value="LOJA 10 - ULTRA POPULAR MONTESE">LOJA 10 - ULTRA POPULAR MONTESE</option>
                        <option value="LOJA 11 - ULTRA POPULAR CANINDE I">LOJA 11 - ULTRA POPULAR CANINDE I</option>
                        <option value="LOJA 12 - POUPE FARMA URUBURETAMA Vermelhinha">LOJA 12 - POUPE FARMA URUBURETAMA Vermelhinha</option>
                        <option value="LOJA 13 - POUPE FARMA URUBURETAMA Amarelinha">LOJA 13 - POUPE FARMA URUBURETAMA Amarelinha</option>
                        <option value="LOJA 14 - MAXI POPULAR ITAPIPOCA">LOJA 14 - MAXI POPULAR ITAPIPOCA</option>
                        <option value="LOJA 15 - POUPE FARMA AMONTADA Vermelhinha">LOJA 15 - POUPE FARMA AMONTADA Vermelhinha</option>
                        <option value="LOJA 16 - ULTRA POPULAR SAO GON√áALO DO AMARANTE">LOJA 16 - ULTRA POPULAR SAO GON√áALO DO AMARANTE</option>
                        <option value="LOJA 17 - ULTRA POPULAR ITAPAJE">LOJA 17 - ULTRA POPULAR ITAPAJE</option>
                        <option value="LOJA 18 - POUPE FARMA AMONTADA Amarelinha">LOJA 18 - POUPE FARMA AMONTADA Amarelinha</option>
                        <option value="LOJA 19 - ULTRA POPULAR SOBRAL I">LOJA 19 - ULTRA POPULAR SOBRAL I</option>
                        <option value="LOJA 22 - ULTRA POPULAR CANINDE II">LOJA 22 - ULTRA POPULAR CANINDE II</option>
                        <option value="LOJA 23 - MAXI POPULAR CANINDE">LOJA 23 - MAXI POPULAR CANINDE</option>
                        <option value="LOJA 27 - ULTRAPOPULAR LIMOEIRO DO NORTE">LOJA 27 - ULTRAPOPULAR LIMOEIRO DO NORTE</option>
                        <option value="LOJA 28 - ULTRA POPULAR JUREMA">LOJA 28 - ULTRA POPULAR JUREMA</option>
                        <option value="LOJA 29 - ULTRA POPULAR ITAITINGA">LOJA 29 - ULTRA POPULAR ITAITINGA</option>
                        <option value="LOJA 30 - GOTA MAIS PR. FERREIRA">LOJA 30 - GOTA MAIS PR. FERREIRA</option>
                        <option value="LOJA 31 - ULTRA POPULAR AQUIRAZ">LOJA 31 - ULTRA POPULAR AQUIRAZ</option>
                        <option value="LOJA 32 - POUPE FARMA S√ÉO BENEDITO">LOJA 32 - POUPE FARMA S√ÉO BENEDITO</option>
                        <option value="LOJA 33 - ULTRA POPULAR VI√áOSA">LOJA 33 - ULTRA POPULAR VI√áOSA</option>
                        <option value="LOJA 34 - ULTRAPOPULAR TEJU√áUOCA">LOJA 34 - ULTRAPOPULAR TEJU√áUOCA</option>
                        <option value="LOJA 35 - MAXI POPULAR TRAIRI">LOJA 35 - MAXI POPULAR TRAIRI</option>
                        <option value="LOJA 36 - ULTRA POPULAR FCO. SA">LOJA 36 - ULTRA POPULAR FCO. SA</option>
                        <option value="LOJA 37 - ULTRA POPULAR IGUATU">LOJA 37 - ULTRA POPULAR IGUATU</option>
                        <option value="LOJA 38 - ULTRA POPULAR TIANGUA">LOJA 38 - ULTRA POPULAR TIANGUA</option>
                        <option value="LOJA 39 - ULTRA POPULAR CONJ. CEARA">LOJA 39 - ULTRA POPULAR CONJ. CEARA</option>
                        <option value="LOJA 42 - ULTRA POPULAR RUSSAS">LOJA 42 - ULTRA POPULAR RUSSAS</option>
                        <option value="LOJA 43 - DROGARIA ULTRA POPULAR BELA CRUZ">LOJA 43 - DROGARIA ULTRA POPULAR BELA CRUZ</option>
                        <option value="LOJA 45 - FARMA VIP ITAREMA">LOJA 45 - FARMA VIP ITAREMA</option>
                        <option value="LOJA 46 - ULTRA POPULAR ACARAU">LOJA 46 - ULTRA POPULAR ACARAU</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>C√≥digo de Barras</label>
                    <input type="text" id="barcode" placeholder="Bipe aqui..." inputmode="numeric" pattern="[0-9]*" autocomplete="off">
                </div>

                <div class="form-group">
                    <label>Produto Identificado</label>
                    <input type="text" id="product" placeholder="Aguardando leitura..." readonly>
                </div>

                <div class="row">
                    <div class="form-group">
                        <label>Lote</label>
                        <input type="text" id="lot" placeholder="Ex: A123" required>
                    </div>
                    <div class="form-group">
                        <label>Quantidade</label>
                        <input type="number" id="qty" placeholder="Ex: 5" min="1" required>
                    </div>
                </div>

                <div class="row">
                    <div class="form-group">
                        <label>Fabrica√ß√£o (M√™s/Ano)</label>
                        <input type="text" id="mfg" placeholder="MM/AAAA" maxlength="7" required>
                    </div>
                    <div class="form-group">
                        <label>Validade (M√™s/Ano)</label>
                        <input type="text" id="exp" placeholder="MM/AAAA" maxlength="7" required>
                    </div>
                </div>

                <button type="submit" id="submit-btn" class="btn btn-primary">
                    <svg class="icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Adicionar √† Lista
                </button>

            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2>
                <svg class="icon" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                Itens Coletados (<span id="count">0</span>)
            </h2>
        </div>
        
        <div class="search-box">
            <svg class="icon search-icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input type="text" id="search" placeholder="Buscar por lote, nome ou c√≥digo...">
        </div>

        <ul id="list" class="item-list">
            </ul>

        <div class="card-body">
            <button id="export-btn" class="btn btn-primary" disabled>
                <svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                Baixar Planilha CSV
            </button>
            <button id="clear-btn" class="btn btn-outline-danger">
                Limpar Lista Completa
            </button>
        </div>
    </div>
</main>

<footer>
    <p>&copy; 2026 SB Farma. Todos os direitos reservados.</p>
    <p>Desenvolvido por <strong>Eduardo Dourado</strong></p>
</footer>

<script>
    /* --- ELEMENTOS --- */
    const el = {
        store: document.getElementById('store'),
        barcode: document.getElementById('barcode'),
        product: document.getElementById('product'),
        lot: document.getElementById('lot'),
        qty: document.getElementById('qty'),
        mfg: document.getElementById('mfg'),
        exp: document.getElementById('exp'),
        form: document.getElementById('inventory-form'),
        list: document.getElementById('list'),
        search: document.getElementById('search'),
        count: document.getElementById('count'),
        exportBtn: document.getElementById('export-btn'),
        clearBtn: document.getElementById('clear-btn'),
        submitBtn: document.getElementById('submit-btn'),
        toastBox: document.getElementById('toast-container')
    };

    /* --- ESTADO --- */
    const API_URL = '/api/produto?codigo=';
    let items = JSON.parse(localStorage.getItem('sb_inventory')) || [];
    let savedStore = localStorage.getItem('sb_store');
    
    if (savedStore) el.store.value = savedStore;

    /* --- HELPERS --- */
    function showToast(msg, type = 'success') {
        const div = document.createElement('div');
        div.className = `toast ${type}`;
        div.innerText = msg;
        el.toastBox.appendChild(div);
        setTimeout(() => { div.remove(); }, 3000);
    }

    // M√°scara de Data (MM/AAAA)
    function maskDate(input) {
        let val = input.value.replace(/\D/g, ''); // Remove tudo que n√£o √© n√∫mero
        if (val.length > 2) val = val.substring(0, 2) + '/' + val.substring(2, 6);
        input.value = val;
    }

    // Formata data para CSV (Adiciona dia 28)
    function formatDateCSV(monthYear) {
        if (!monthYear || monthYear.length < 7) return '';
        return `28/${monthYear}`;
    }

    /* --- EVENTOS --- */
    
    // Salvar Loja
    el.store.addEventListener('change', () => localStorage.setItem('sb_store', el.store.value));

    // Lote: Mai√∫sculo
    el.lot.addEventListener('input', e => {
        e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    });

    // M√°scaras de Data
    el.mfg.addEventListener('input', e => maskDate(e.target));
    el.exp.addEventListener('input', e => maskDate(e.target));

    // Buscar Produto
    el.barcode.addEventListener('change', async () => {
        const code = el.barcode.value.trim();
        if (code.length < 3) return;

        el.product.value = 'Buscando...';
        try {
            const res = await fetch(API_URL + code);
            if (res.ok) {
                const data = await res.json();
                el.product.value = data.nome;
                el.lot.focus();
            } else {
                el.product.value = 'PRODUTO N√ÉO CADASTRADO';
                showToast('Produto n√£o encontrado', 'error');
            }
        } catch {
            el.product.value = 'ERRO DE CONEX√ÉO';
        }
    });

    // Renderizar Lista
    function render() {
        const term = el.search.value.toLowerCase();
        const filtered = items.filter(i => 
            i.produto.toLowerCase().includes(term) || 
            i.lote.toLowerCase().includes(term) || 
            i.barcode.includes(term)
        );

        el.count.innerText = items.length;
        el.exportBtn.disabled = items.length === 0;

        if (filtered.length === 0) {
            el.list.innerHTML = `<li style="padding:2rem; text-align:center; color:#9ca3af;">Nenhum item encontrado.</li>`;
            return;
        }

        el.list.innerHTML = filtered.map(i => `
            <li class="list-item">
                <div class="item-content">
                    <h4>${i.produto}</h4>
                    <div class="meta-info">
                        <span class="meta-tag">üè≠ Lote: ${i.lote}</span>
                        <span class="meta-tag">üìÖ Val: ${i.exp}</span>
                        <span class="meta-tag">üì¶ Qtd: ${i.qty}</span>
                    </div>
                </div>
                <div class="actions">
                    <button class="icon-btn" onclick="editItem(${i.id})">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>
                    <button class="icon-btn delete" onclick="deleteItem(${i.id})">
                        <svg class="icon" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div>
            </li>
        `).join('');
        
        localStorage.setItem('sb_inventory', JSON.stringify(items));
    }

    // CRUD
    el.form.addEventListener('submit', e => {
        e.preventDefault();
        
        if (!el.store.value) return showToast('Selecione a loja!', 'error');
        if (el.product.value.includes('N√ÉO') || el.product.value.includes('ERRO')) return showToast('Produto inv√°lido.', 'error');
        if (el.mfg.value.length < 7 || el.exp.value.length < 7) return showToast('Preencha as datas corretamente (MM/AAAA)', 'error');

        // Duplicidade Check
        const exists = items.some(i => i.barcode === el.barcode.value && i.lote === el.lot.value);
        if (exists) return showToast('Lote j√° cadastrado para este produto!', 'error');

        const newItem = {
            id: Date.now(),
            store: el.store.value,
            barcode: el.barcode.value,
            produto: el.product.value,
            lote: el.lot.value,
            qty: el.qty.value,
            mfg: el.mfg.value,
            exp: el.exp.value
        };

        items.unshift(newItem);
        render();
        
        // Reset Inputs
        el.lot.value = ''; el.qty.value = ''; el.mfg.value = ''; el.exp.value = '';
        el.product.value = ''; el.barcode.value = '';
        el.submitBtn.innerHTML = `
            <svg class="icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Adicionar √† Lista
        `;
        el.barcode.focus();
        showToast('Item adicionado!', 'success');
    });

    window.deleteItem = id => {
        if(confirm('Excluir item?')) {
            items = items.filter(i => i.id !== id);
            render();
        }
    };

    window.editItem = id => {
        const i = items.find(x => x.id === id);
        if(!i) return;

        el.store.value = i.store;
        el.barcode.value = i.barcode;
        el.product.value = i.produto;
        el.lot.value = i.lote;
        el.qty.value = i.qty;
        el.mfg.value = i.mfg;
        el.exp.value = i.exp;

        items = items.filter(x => x.id !== id);
        render();
        el.submitBtn.innerText = 'üíæ Salvar Altera√ß√£o';
        el.lot.focus();
    };

    // Exportar CSV
    el.exportBtn.addEventListener('click', () => {
        const BOM = "\uFEFF";
        let csv = BOM; // Sem cabe√ßalho
        
        items.forEach(i => {
            // Extrai n√∫mero da loja (ex: "LOJA 10..." -> "10")
            let storeNumber = i.store.match(/\d+/);
            storeNumber = storeNumber ? storeNumber[0] : "00"; 

            csv += [
                storeNumber, // AGORA SIM: Apenas o n√∫mero "10", "01", etc
                i.barcode,
                i.lote,
                i.qty,
                formatDateCSV(i.mfg),
                formatDateCSV(i.exp) 
            ].join(';') + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        const date = new Date().toISOString().slice(0,10);
        link.download = `Inventario_SBFARMA_${date}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    el.clearBtn.addEventListener('click', () => {
        if(confirm('Apagar TUDO?')) {
            items = []; render(); localStorage.removeItem('sb_inventory');
        }
    });

    el.search.addEventListener('input', render);
    render();

</script>
</body>
</html>